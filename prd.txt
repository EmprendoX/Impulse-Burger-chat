PRD ‚Äî IMPULSE Order Chat, Tracking & Delivery System
1. Overview
Nombre del sistema:
IMPULSE Order Confirmation & Delivery Tracking
Prop√≥sito:
Crear un sistema propio y confiable que permita:
	‚Ä¢ Confirmar pedidos autom√°ticamente despu√©s del pago
	‚Ä¢ Comunicar el estado del pedido por WhatsApp
	‚Ä¢ Permitir seguimiento en tiempo real del repartidor
	‚Ä¢ Evitar fricci√≥n operativa en cocina y reparto
	‚Ä¢ Eliminar dependencia de n8n u otros parches
Este sistema funciona como columna vertebral operativa de IMPULSE para delivery propio.

2. Objetivos del producto
Objetivos primarios
	1. Confirmar pedidos autom√°ticamente al recibir pago exitoso.
	2. Enviar mensajes de confirmaci√≥n y estado v√≠a WhatsApp.
	3. Proveer tracking en tiempo real tipo ‚ÄúUber-like‚Äù sin app.
	4. Separar claramente:
		‚óã Cliente
		‚óã Cocina
		‚óã Repartidor
Objetivos secundarios
	‚Ä¢ Evitar mensajes duplicados.
	‚Ä¢ Permitir escalar a m√∫ltiples cocinas.
	‚Ä¢ Mantener c√≥digo claro y portable (Cursor-first).

3. Usuarios y roles
3.1 Cliente final
	‚Ä¢ Realiza pedido y paga.
	‚Ä¢ Recibe confirmaci√≥n por WhatsApp.
	‚Ä¢ Puede seguir al repartidor en tiempo real.
	‚Ä¢ No interact√∫a con cocina directamente.
3.2 Repartidor
	‚Ä¢ Recibe link √∫nico por pedido.
	‚Ä¢ Abre link desde su celular (sin app).
	‚Ä¢ Comparte ubicaci√≥n GPS autom√°ticamente.
	‚Ä¢ No ve datos sensibles del cliente.
3.3 Sistema IMPULSE (backend)
	‚Ä¢ Valida pedidos.
	‚Ä¢ Genera tokens seguros.
	‚Ä¢ Controla estados.
	‚Ä¢ Env√≠a mensajes WhatsApp.
	‚Ä¢ Expone tracking.

4. Flujo general del sistema (alto nivel)
Pago exitoso
   ‚Üì
POST /api/orders/paid
   ‚Üì
Crear / actualizar pedido
   ‚Üì
Enviar WhatsApp confirmaci√≥n (template)
   ‚Üì
Repartidor abre link /c/:orderNumber
   ‚Üì
GPS se env√≠a cada pocos segundos
   ‚Üì
Cliente ve mapa en /t/:orderNumber

5. Componentes del sistema
5.1 Backend
	‚Ä¢ Node.js + Express
	‚Ä¢ TypeScript
	‚Ä¢ Prisma ORM
	‚Ä¢ SQLite (dev) / PostgreSQL (prod)
5.2 Frontend m√≠nimo
	‚Ä¢ HTML + JS puro (sin frameworks)
	‚Ä¢ Leaflet + OpenStreetMap para mapas
	‚Ä¢ Web APIs (navigator.geolocation)
5.3 Integraciones externas
	‚Ä¢ WhatsApp Cloud API (Meta)
	‚Ä¢ Proveedor de pagos (externo, no parte de este PRD)

6. Endpoints (API)
6.1 Crear / confirmar pedido
Endpoint
POST /api/orders/paid
Headers
x-impulse-secret: <IMPULSE_ORDER_SECRET>
Body
{
  "orderNumber": "IMP-047",
  "customer": {
    "name": "Juan",
    "phone": "+52 55 1234 5678"
  },
  "items": [
    { "name": "Smash Burger", "qty": 2 },
    { "name": "Papas", "qty": 1 }
  ],
  "total": "420",
  "paymentStatus": "paid",
  "paymentMethod": "online",
  "address": "CDMX"
}
Resultado
	‚Ä¢ Crea pedido si no existe.
	‚Ä¢ Actualiza pedido si ya existe.
	‚Ä¢ Genera:
		‚óã customerToken
		‚óã courierToken
	‚Ä¢ Env√≠a WhatsApp de confirmaci√≥n (1 sola vez).
	‚Ä¢ Devuelve links de tracking.

6.2 Recibir ubicaci√≥n del repartidor
Endpoint
POST /api/courier/location
Body
{
  "orderNumber": "IMP-047",
  "token": "<courierToken>",
  "lat": 19.3901,
  "lng": -99.2456,
  "accuracy": 12
}
Comportamiento
	‚Ä¢ Valida token.
	‚Ä¢ Guarda ubicaci√≥n.
	‚Ä¢ Actualiza estado a ON_THE_WAY.
	‚Ä¢ Env√≠a WhatsApp ‚Äúva en camino‚Äù (1 sola vez).

6.3 Tracking para cliente
Endpoint
GET /api/track/:orderNumber?token=<customerToken>
Respuesta
{
  "ok": true,
  "location": {
    "lat": 19.39,
    "lng": -99.24,
    "accuracy": 12,
    "updatedAt": "2026-01-27T18:42:00Z"
  }
}

7. Rutas p√∫blicas (HTML)
7.1 Tracking cliente
GET /t/:orderNumber?token=...
Funci√≥n
	‚Ä¢ Mostrar mapa.
	‚Ä¢ Consultar /api/track cada 5 segundos.
	‚Ä¢ Mover marcador del repartidor.

7.2 Tracking repartidor
GET /c/:orderNumber?token=...
Funci√≥n
	‚Ä¢ Pedir permiso de ubicaci√≥n.
	‚Ä¢ Enviar GPS autom√°ticamente al backend.
	‚Ä¢ No requiere login ni app.

8. WhatsApp (mensajer√≠a)
8.1 Tipo de mensajes
	‚Ä¢ Business-initiated (empresa inicia)
	‚Ä¢ Requiere templates Utility aprobados

8.2 Template: Confirmaci√≥n de pedido
Nombre
impulse_order_confirm_v1
Idioma
es_MX
Variables
{{1}} = orderNumber
{{2}} = total
{{3}} = customerTrackingUrl
Ejemplo
	Pedido IMP-047 confirmado ‚úÖ
	Total $420
	Sigue tu pedido aqu√≠:  https://impulse.mx/t/IMP-047?token=...

8.3 Template: Pedido en camino
Nombre
impulse_on_the_way_v1
Variables
{{1}} = orderNumber
{{2}} = customerTrackingUrl
Ejemplo
	Tu pedido IMP-047 va en camino üöó
	S√≠guelo aqu√≠:  https://impulse.mx/t/IMP-047?token=...

9. Seguridad
9.1 Tokens
	‚Ä¢ Tokens aleatorios (hex).
	‚Ä¢ Separaci√≥n:
		‚óã customerToken
		‚óã courierToken
	‚Ä¢ No reutilizables entre roles.
9.2 Secretos
	‚Ä¢ IMPULSE_ORDER_SECRET obligatorio para crear pedidos.
	‚Ä¢ Evita llamadas externas no autorizadas.

10. Idempotencia
	‚Ä¢ Cada evento WhatsApp se registra en tabla OrderEvent.
	‚Ä¢ Restricci√≥n √∫nica por:
		‚óã (orderId, CONFIRM_SENT)
		‚óã (orderId, ON_THE_WAY_SENT)
	‚Ä¢ Evita mensajes duplicados aunque el webhook se repita.

11. Estados del pedido
CONFIRMED ‚Üí PREPARING ‚Üí READY ‚Üí ON_THE_WAY ‚Üí DELIVERED
Para este MVP, el sistema maneja autom√°ticamente:
	‚Ä¢ CONFIRMED
	‚Ä¢ ON_THE_WAY
Los dem√°s pueden integrarse despu√©s.

12. No-Goals (expl√≠cito)
Este sistema NO incluye:
	‚Ä¢ Cat√°logo de productos
	‚Ä¢ Pagos
	‚Ä¢ Gesti√≥n de cocina
	‚Ä¢ App nativa
	‚Ä¢ Optimizaci√≥n de rutas
	‚Ä¢ Multi-repartidor por pedido

13. M√©tricas clave (futuro)
	‚Ä¢ Tiempo entre pago y confirmaci√≥n
	‚Ä¢ Tiempo de entrega
	‚Ä¢ % pedidos con tracking activo
	‚Ä¢ % errores de ubicaci√≥n

14. Estado del PRD
Versi√≥n: 1.0
Estado: Ready for implementation
Plataforma objetivo: Cursor (Node + TS)

Si quieres, el siguiente paso natural es:
	‚Ä¢ Convertir este PRD en un TASKLIST.md para Cursor
	‚Ä¢ O dividirlo en √©picas / historias t√©cnicas
	‚Ä¢ O preparar la versi√≥n multi-cocina
T√∫ dime c√≥mo quieres seguir, pero este PRD ya est√° listo para usarse tal cual.